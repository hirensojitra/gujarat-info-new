<div class="image-manager-container">

  <!-- Header -->
  <header class="manager-header">
    <div class="header-left">
      <h3 class="header-title">Image Manager</h3>
      <span class="folder-path text-muted">
        {{ selectedFolder ? selectedFolder.name : 'All folders' }}
      </span>
    </div>
    <div class="header-right">
      <button *ngIf="canUpload()" class="btn btn-primary upload-btn" (click)="fileInput.click()">
        <i class="fa fa-upload me-2"></i>Upload Images
      </button>
      <input type="file" #fileInput hidden multiple (change)="onFileSelected($event)" />
    </div>
  </header>

  <!-- Main Content Area -->
  <div class="main-content-area">
    <!-- Folder Sidebar -->
    <aside class="folder-sidebar">
      <h5 class="sidebar-title">Folders</h5>

      <div *ngIf="canUpload()" class="new-folder-input-group">
        <input type="text" class="form-control" [(ngModel)]="newFolderName" placeholder="New folder name" />
        <button class="btn btn-success" (click)="createFolder()" [disabled]="!newFolderName?.trim()">
          <i class="fa fa-plus"></i>
        </button>
      </div>

      <div class="folder-search-bar">
        <input type="text" class="form-control" placeholder="Search folders..." [(ngModel)]="search"
          (ngModelChange)="loadFolders()" />
      </div>

      <ul class="folder-list">
        <li *ngFor="let folder of folders"
            class="folder-list-item"
            [class.active]="folder.id === selectedFolder?.id"
            (click)="selectFolder(folder)">
          <span class="folder-name"><i class="fa fa-folder me-2"></i>{{ folder.name }}</span>
          <button class="btn btn-sm btn-outline-danger delete-folder-btn" (click)="deleteFolder(folder); $event.stopPropagation();">
            <i class="fa fa-trash"></i>
          </button>
        </li>
      </ul>
    </aside>

    <!-- Image Display Area -->
    <section class="image-display-area">
      <div *ngIf="images.length === 0 && !loading.images" class="no-images-placeholder">
        <i class="fa fa-picture-o no-images-icon"></i>
        <p class="no-images-text">No images found in this folder.</p>
        <button *ngIf="canUpload()" class="btn btn-primary mt-3" (click)="fileInput.click()">
          <i class="fa fa-upload me-2"></i>Upload First Image
        </button>
      </div>

      <div class="image-grid-container" *ngIf="images.length > 0 || loading.images">
        <div class="row g-3">
          <div *ngFor="let image of images" class="col-6 col-sm-4 col-md-3 col-lg-2">
            <div class="image-card">
              <div class="image-thumbnail" role="img"
                [ngStyle]="{
                  'background-image': 'url(' + apiUrl + '/user-img/uploads/' + image.id + '?thumb=medium)',
                  'background-size': 'contain',
                  'background-position': 'center',
                  'background-repeat': 'no-repeat'
                }"
                [attr.aria-label]="image.metadata || 'Image'">
              </div>
              <div class="image-info">
                <span class="image-name">{{ image.image_url || 'Unnamed' }}</span>
                <div class="dropdown">
                  <button class="btn btn-sm image-options-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa fa-ellipsis-v"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><button class="dropdown-item" (click)="copyHrefToClipboard($event,image)">
                      <i class="fa fa-copy me-2"></i>Copy URL</button></li>
                    <li><button class="dropdown-item" (click)="refreshImage(image)">
                      <i class="fa fa-refresh me-2"></i>Refresh</button></li>
                    <li><button class="dropdown-item text-danger" (click)="openConfirmModal(image)">
                      <i class="fa fa-trash me-2"></i>Delete</button></li>
                    <li><a class="dropdown-item" [href]="apiUrl + '/user-img/uploads/' + image.id" target="_blank">
                      <i class="fa fa-eye me-2"></i>Open</a></li>
                    <li><a class="dropdown-item" [href]="apiUrl + '/user-img/uploads/' + image.id" download>
                      <i class="fa fa-download me-2"></i>Download</a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div *ngIf="totalImages > 0" class="pagination-container">
        <div pagination [currentPage]="imagePage" [totalItems]="totalImages" [pageSize]="imageLimit"
          [pageSizes]="[12, 24, 48]" (currentPageChange)="onImagePageChange($event)"
          (pageSizeChange)="onImagePageSizeChange($event)">
        </div>
      </div>
    </section>
  </div>

  <!-- No Access -->
  <div *ngIf="!canView()" class="alert alert-warning no-access-alert">
    You do not have permission to view this content.
  </div>

  <!-- Confirm Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ modalTitle }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">{{ modalMessage }}</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" (click)="confirmModal()">Yes</button>
        </div>
      </div>
    </div>
  </div>
</div>