import{a as G}from"./chunk-5QCEUJXI.js";import{a as Y,b as $}from"./chunk-LWD4NL2D.js";import{a as w}from"./chunk-HJBLNEFI.js";import{e as M}from"./chunk-EU3RJ4QC.js";import{a as E}from"./chunk-DMITPIK3.js";import{a as q}from"./chunk-2PNCHW4B.js";import"./chunk-6SPVWCZN.js";import{c as V,d as f,f as O,g as F,k as L,o as P,r as j,v as N,x as A,y as R,z as D}from"./chunk-23EI4VKN.js";import{Da as b,Ea as _,K as p,La as m,Lb as C,Na as h,Nb as I,P as g,Q as d,Qb as u,Va as T,ga as l,ha as r,hb as S,jb as k,pa as v,ra as c,rb as x,xa as n,ya as a,za as y}from"./chunk-4GDYXFLP.js";import"./chunk-CWTPBX7D.js";var X=i=>({"is-invalid":i});function Z(i,te){if(i&1&&(n(0,"div",9),m(1),a()),i&2){let o=_();l(),h(" ",o.errorMessage," ")}}var K=(()=>{class i{constructor(o,e,t,s,H,J,Q,U,W){this.route=o,this.fb=e,this.apollo=t,this.router=s,this.toast=H,this.registerService=J,this.loginService=Q,this.authCookie=U,this.cookieService=W,this.loading=!1,this.errorMessage="",this.userId="",this.emailOtpToken="",this.timeLeft=0}ngOnInit(){this.verifyForm=this.fb.group({otp_code:["",[f.required,f.minLength(6),f.maxLength(6)]]}),this.route.queryParams.subscribe(o=>{this.userId=o.user_id,this.emailOtpToken=this.authCookie.getOtpToken();let e=this.cookieService.get("otp_expires_at");if(!this.emailOtpToken||!e)this.toast.show("Verification session expired.",{class:"bg-danger"}),this.router.navigate(["/authentication/login"]);else{let t=new Date(e).getTime(),s=Date.now();this.timeLeft=Math.floor((t-s)/1e3),this.timeLeft<=0?(this.toast.show("OTP expired. Please request a new one.",{class:"bg-danger"}),this.authCookie.removeOtpToken(),this.cookieService.delete("otp_expires_at","/"),this.router.navigate(["/authentication/login"])):this.startTimer()}})}startTimer(){this.timerInterval=setInterval(()=>{this.timeLeft>0?this.timeLeft--:(this.stopTimer(),this.toast.show("OTP expired. Please request a new one.",{class:"bg-danger"}),this.authCookie.removeOtpToken(),this.cookieService.delete("otp_expires_at","/"),this.router.navigate(["/authentication/login"]))},1e3)}stopTimer(){this.timerInterval&&clearInterval(this.timerInterval)}verifyOtp(){if(this.verifyForm.invalid)return;this.loading=!0;let o=this.verifyForm.value.otp_code;this.apollo.mutate({mutation:Y,variables:{token:this.emailOtpToken,otp_code:o}}).subscribe({next:()=>{this.loading=!1,this.toast.show("Email verified successfully!",{class:"bg-success"}),this.authCookie.removeOtpToken(),this.cookieService.delete("otp_expires_at","/"),this.stopTimer(),this.autoLoginAfterVerification()},error:e=>{this.loading=!1,this.toast.show(e.message||"Verification failed.",{class:"bg-danger"})}})}formatTime(o){let e=Math.floor(o/60),t=o%60;return`${e}:${t<10?"0"+t:t}`}autoLoginAfterVerification(){let o=this.registerService.getEmail(),e=this.registerService.getPassKey();if(console.log(o,e),!o||!e){this.toast.show("Session expired. Please login again.",{class:"bg-danger"}),this.router.navigate(["/auth/login"]);return}this.loginService.login({login_id:o,pass_key:e}).subscribe({next:t=>{this.loading=!1,this.authCookie.setToken(t.token),this.toast.show("Logged in successfully!",{class:"bg-success"})},error:t=>{this.loading=!1,this.toast.show("Login failed. Please try again.",{class:"bg-danger"}),this.router.navigate(["/auth/login"])}})}ngOnDestroy(){this.stopTimer()}static{this.\u0275fac=function(e){return new(e||i)(r(C),r(A),r(M),r(I),r(q),r($),r(G),r(w),r(E))}}static{this.\u0275cmp=g({type:i,selectors:[["app-verify-email"]],decls:14,vars:7,consts:[[1,"card-title","text-center","mb-4"],[3,"ngSubmit","formGroup"],[1,"form-group","mb-3"],["for","otp_code",1,"form-label"],["type","text","id","otp_code","formControlName","otp_code","maxlength","6","placeholder","Enter 6-digit OTP",1,"form-control",3,"ngClass"],[1,"text-muted","mt-1","d-block"],[1,"text-danger","mt-1","d-block"],["type","submit",1,"btn","btn-primary","w-100",3,"disabled"],["class","alert alert-danger mt-3",4,"ngIf"],[1,"alert","alert-danger","mt-3"]],template:function(e,t){if(e&1&&(n(0,"h3",0),m(1,"Verify Your Email"),a(),n(2,"form",1),b("ngSubmit",function(){return t.verifyOtp()}),n(3,"div",2)(4,"label",3),m(5,"Enter OTP"),a(),y(6,"input",4),n(7,"small",5),m(8," This OTP is valid for 15 minutes. "),a(),n(9,"small",6),m(10),a(),n(11,"button",7),m(12," Verify OTP "),a(),v(13,Z,2,1,"div",8),a()()),e&2){let s;l(2),c("formGroup",t.verifyForm),l(4),c("ngClass",T(5,X,((s=t.verifyForm.get("otp_code"))==null?null:s.invalid)&&((s=t.verifyForm.get("otp_code"))==null?null:s.touched))),l(4),h(" Time left: ",t.formatTime(t.timeLeft)," "),l(),c("disabled",t.verifyForm.invalid||t.loading),l(2),c("ngIf",t.errorMessage)}},dependencies:[S,k,L,V,O,F,N,P,j]})}}return i})();var ee=[{path:"",component:K,data:{title:"PostNew | Register",description:"Login or register to PostNew portal for accessing services",keywords:"PostNew, login, register, portal",robots:"index, follow",image:"https://test-ssr-hiren.netlify.app/assets/images/jpg/register.jpg"}}],z=(()=>{class i{static{this.\u0275fac=function(e){return new(e||i)}}static{this.\u0275mod=d({type:i})}static{this.\u0275inj=p({imports:[u.forChild(ee),u]})}}return i})();var Se=(()=>{class i{static{this.\u0275fac=function(e){return new(e||i)}}static{this.\u0275mod=d({type:i})}static{this.\u0275inj=p({imports:[x,z,R,D]})}}return i})();export{Se as VerifyEmailModule};
