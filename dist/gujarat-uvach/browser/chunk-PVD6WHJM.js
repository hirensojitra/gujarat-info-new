import{a as Q}from"./chunk-TMYTY45U.js";import{a as J}from"./chunk-7WMUUMW3.js";import"./chunk-VCSFWOKU.js";import{m as j}from"./chunk-SQRP6PMK.js";import{a as P}from"./chunk-EEYGSOZM.js";import{a as F}from"./chunk-7YVPWAOW.js";import{a as L}from"./chunk-RWKAEW2Z.js";import{a as z}from"./chunk-US3D65CF.js";import"./chunk-ZMNXU5KO.js";import"./chunk-WIB4C2YZ.js";import{A as $,B,C as K,c as N,e as f,g as R,h as A,m as D,q,t as G,y as H}from"./chunk-ZDPQXU7Z.js";import{s as M,u as V,w as y}from"./chunk-KB4EY57F.js";import{$b as k,Db as v,Fb as d,K as g,O as T,Qb as l,Rb as a,Sb as C,Zb as b,a as _,kb as s,kc as c,kd as E,la as u,lb as n,mc as p,md as I,va as w,w as S,wa as h,wc as x,wd as O}from"./chunk-YECJCXI6.js";import"./chunk-CWTPBX7D.js";var re=o=>({"is-invalid":o});function se(o,Y){o&1&&(l(0,"div",11),c(1," Please enter a valid 6-digit code. "),a())}function ne(o,Y){if(o&1&&(l(0,"div",12),c(1),a()),o&2){let t=k();s(),p(" ",t.errorMessage," ")}}var W=(()=>{class o{constructor(t,i,e,r,m,Z,ee,te,ie,oe){this.route=t,this.fb=i,this.apollo=e,this.router=r,this.toast=m,this.registerService=Z,this.loginService=ee,this.authCookie=te,this.cookieService=ie,this.authService=oe,this.loading=!1,this.errorMessage="",this.userId="",this.emailOtpToken="",this.timeLeft=0,this.resendCooldown=0,this.user=null,this.subscriptions=new _}ngOnInit(){this.subscriptions.add(this.authService.user$.subscribe(r=>{this.user=r,console.log("user",this.user)})),this.verifyForm=this.fb.group({otp_code:["",[f.required,f.minLength(6),f.maxLength(6)]]}),this.emailOtpToken=this.authCookie.getOtpToken();let t=this.cookieService.get("otp_expires_at");if(!this.emailOtpToken||!t){this.toast.show("Verification session expired.",{class:"bg-danger"});return}let i=new Date(t).getTime(),e=Date.now();this.timeLeft=Math.floor((i-e)/1e3),this.timeLeft<=0?this.expireSession():this.startTimer(),this.resendCooldown=0}startTimer(){this.timerSub=g(1e3).subscribe(()=>{this.timeLeft--,this.timeLeft<=0&&this.expireSession()})}expireSession(){this.stopTimer(),this.toast.show("OTP expired. Please request a new one.",{class:"bg-danger"}),this.authCookie.removeOtpToken(),this.cookieService.delete("otp_expires_at","/"),this._navigateToLogin(this.router.url)}stopTimer(){this.timerSub?.unsubscribe()}verifyOtp(){if(this.verifyForm.invalid)return;this.loading=!0;let t=this.verifyForm.value.otp_code,i=this.emailOtpToken;this.registerService.verifyOtp(i,t).pipe(T(e=>(this.loading=!1,this.toast.show(e.message||"Verification failed.",{class:"bg-danger"}),S(()=>e)))).subscribe(({token:e,user:r})=>{this.loading=!1,this.authService.saveSession(e,r),this.toast.show("Email verified successfully!",{class:"bg-success"}),this.clearSession(),this._navigateToHome()})}onResend(){if(this.resendCooldown>0)return;let t=this.user.email;if(!t){this.toast.show("Session expired. Please login again.",{class:"bg-danger"}),this._navigateToLogin(this.router.url);return}this.registerService.resendOtp(t).subscribe({next:({data:i})=>{let{email_otp_token:e,otp_expires_at:r}=i.resendEmailOtp;this.authCookie.setOtpToken(e,r),this.emailOtpToken=e,this.stopTimer();let m=new Date(r).getTime();this.timeLeft=Math.floor((m-Date.now())/1e3),this.startTimer(),this.resendCooldown=30,this.cooldownSub=g(1e3).subscribe(()=>{this.resendCooldown--,this.resendCooldown<=0&&this.cooldownSub?.unsubscribe()}),this.toast.show("OTP resent. Check your inbox.",{class:"bg-success"})},error:i=>{this.toast.show(i.message||"Could not resend OTP.",{class:"bg-danger"})}})}formatTime(t){let i=Math.floor(t/60),e=t%60;return`${i}:${e<10?"0"+e:e}`}autoLoginAfterVerification(){let t=this.registerService.getEmail(),i=this.registerService.getPassKey();if(!t||!i){this.toast.show("Session expired. Please login again.",{class:"bg-danger"}),this._navigateToLogin(this.router.url);return}this.loginService.login({login_id:t,pass_key:i}).subscribe({next:e=>{this.authCookie.setToken(e.token),this.toast.show("Logged in successfully!",{class:"bg-success"}),this._navigateToHome()},error:()=>{this.toast.show("Login failed. Please try again.",{class:"bg-danger"}),this._navigateToLogin(this.router.url)}})}clearSession(){this.stopTimer(),this.cooldownSub?.unsubscribe(),this.authCookie.removeOtpToken(),this.cookieService.delete("otp_expires_at","/")}ngOnDestroy(){this.clearSession()}_navigateToLogin(t){this.router.navigate(["/authentication/login"],{queryParams:{returnUrl:t},queryParamsHandling:"merge"})}_navigateToHome(){this.router.navigate(["/home"])}static{this.\u0275fac=function(i){return new(i||o)(n(M),n($),n(j),n(V),n(z),n(J),n(Q),n(F),n(L),n(P))}}static{this.\u0275cmp=w({type:o,selectors:[["app-verify-email"]],decls:17,vars:11,consts:[[1,"d-flex","flex-column","align-items-center","justify-content-center"],[1,"w-100","px-3",2,"max-width","400px",3,"ngSubmit","formGroup"],[1,"mb-3"],["for","otp_code",1,"form-label"],["id","otp_code","type","text","formControlName","otp_code","maxlength","6",1,"form-control",3,"ngClass"],["class","invalid-feedback",4,"ngIf"],[1,"mb-2","text-muted"],[1,"mb-3","text-center"],["type","button",1,"btn","btn-link","p-0",3,"click","disabled"],["type","submit",1,"btn","btn-primary","w-100",3,"disabled"],["class","alert alert-danger mt-3",4,"ngIf"],[1,"invalid-feedback"],[1,"alert","alert-danger","mt-3"]],template:function(i,e){if(i&1&&(l(0,"div",0)(1,"h2"),c(2,"Email Verification"),a(),l(3,"form",1),b("ngSubmit",function(){return e.verifyOtp()}),l(4,"div",2)(5,"label",3),c(6,"Enter OTP"),a(),C(7,"input",4),v(8,se,2,0,"div",5),a(),l(9,"div",6),c(10),a(),l(11,"div",7)(12,"button",8),b("click",function(){return e.onResend()}),c(13),a()(),l(14,"button",9),c(15),a(),v(16,ne,2,1,"div",10),a()()),i&2){let r,m;s(3),d("formGroup",e.verifyForm),s(4),d("ngClass",x(9,re,((r=e.verifyForm.get("otp_code"))==null?null:r.invalid)&&((r=e.verifyForm.get("otp_code"))==null?null:r.touched))),s(),d("ngIf",((m=e.verifyForm.get("otp_code"))==null?null:m.invalid)&&((m=e.verifyForm.get("otp_code"))==null?null:m.touched)),s(2),p(" Time left: ",e.formatTime(e.timeLeft)," "),s(2),d("disabled",e.resendCooldown>0),s(),p(" ",e.resendCooldown>0?"Resend OTP ("+e.resendCooldown+"s)":"Resend OTP"," "),s(),d("disabled",e.verifyForm.invalid||e.loading),s(),p(" ",e.loading?"Verifying\u2026":"Verify OTP"," "),s(),d("ngIf",e.errorMessage)}},dependencies:[E,I,D,N,R,A,H,q,G]})}}return o})();var ae=[{path:"",component:W,data:{title:"PostNew | Register",description:"Login or register to PostNew portal for accessing services",keywords:"PostNew, login, register, portal",robots:"index, follow",image:"https://test-ssr-hiren.netlify.app/assets/images/jpg/register.jpg"}}],X=(()=>{class o{static{this.\u0275fac=function(i){return new(i||o)}}static{this.\u0275mod=h({type:o})}static{this.\u0275inj=u({imports:[y.forChild(ae),y]})}}return o})();var Oe=(()=>{class o{static{this.\u0275fac=function(i){return new(i||o)}}static{this.\u0275mod=h({type:o})}static{this.\u0275inj=u({imports:[O,X,B,K]})}}return o})();export{Oe as VerifyEmailModule};
