import{a as Y}from"./chunk-EZV327NT.js";import{l as W,n as F}from"./chunk-QLZUZ3RB.js";import{a as Q}from"./chunk-TA2AY7PX.js";import{a as G}from"./chunk-ZVTIIPRU.js";import{a as re}from"./chunk-4V34LOIN.js";import{g as oe,r as se}from"./chunk-XCZXEFLX.js";import"./chunk-PT4ZZHU7.js";import"./chunk-32SRTGJU.js";import{A as ee,B as te,C as ie,c as U,e as c,g as z,h as H,m as J,q as K,t as X,y as Z}from"./chunk-Q2AVQJVA.js";import{u as V,v as B,w as T}from"./chunk-L7QDSQPY.js";import{$b as h,B as x,Db as f,Ea as k,Fa as R,Fb as l,K as M,O as P,Qb as o,Rb as m,Sb as S,Wb as E,Zb as C,ea as _,g as q,id as j,jc as s,ka as L,kb as a,kd as D,la as w,lb as p,lc as y,pa as N,ud as A,va as $,vc as b,w as u,wa as v}from"./chunk-WBTZQM6H.js";import"./chunk-CWTPBX7D.js";var ne=F`
  mutation RequestPasswordReset($email: String!) {
    requestPasswordReset(email: $email) {
      reset_otp_token
      otp_expires_at
    }
  }
`,ae=F`
  mutation ResetPasswordByOtp(
    $token: String!
    $otp_code: String!
    $new_pass_key: String!
  ) {
    resetPasswordByOtp(
      token: $token
      otp_code: $otp_code
      new_pass_key: $new_pass_key
    ) {
      token
      user {
        id
        firstname
        middlename
        lastname
        number
        number_verified
        role_id
        email
        email_verified
        username
        birthday
        gender
        marital_status
        language {
          id
          name
        }
      }
    }
  }
`;var me=(()=>{class i{constructor(t){this.apollo=t}requestPasswordReset(t){return this.apollo.mutate({mutation:ne,variables:{email:t},fetchPolicy:"network-only",errorPolicy:"none"}).pipe(x(e=>{if(!e.data)throw new Error("No data received");return e.data.requestPasswordReset}),P(e=>{let r=e.graphQLErrors?.[0]?.message;if(r)return u(()=>new Error(r));let d=e.networkError?.message;return u(()=>new Error(d||e.message))}))}resetPasswordByOtp(t){return this.apollo.mutate({mutation:ae,variables:{token:t.token,otp_code:t.otp_code,new_pass_key:t.new_pass_key},fetchPolicy:"network-only",errorPolicy:"none"}).pipe(x(e=>{if(!e.data)throw new Error("No data received");return e.data.resetPasswordByOtp}),P(e=>{let r=e.graphQLErrors?.[0]?.message;if(r)return u(()=>new Error(r));let d=e.networkError?.message;return u(()=>new Error(d||e.message))}))}static{this.\u0275fac=function(e){return new(e||i)(N(W))}}static{this.\u0275prov=L({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var O=i=>({"is-invalid":i});function fe(i,g){i&1&&(o(0,"div",10),s(1," Please enter a valid email. "),m())}function he(i,g){if(i&1){let t=E();o(0,"form",2),C("ngSubmit",function(){k(t);let r=h();return R(r.onRequestOtp())}),o(1,"div",3)(2,"label",4),s(3,"Email Address"),m(),S(4,"input",5),f(5,fe,2,0,"div",6),m(),o(6,"button",7),s(7),m(),o(8,"div",8)(9,"p"),s(10," Remembered your password? "),o(11,"a",9),s(12,"Sign In"),m()(),o(13,"p"),s(14," Don't have an account? "),o(15,"a",9),s(16,"Register"),m()()()()}if(i&2){let t,e,r=h();l("formGroup",r.requestForm),a(4),l("ngClass",b(7,O,((t=r.requestForm.get("email"))==null?null:t.invalid)&&((t=r.requestForm.get("email"))==null?null:t.touched))),a(),l("ngIf",((e=r.requestForm.get("email"))==null?null:e.invalid)&&((e=r.requestForm.get("email"))==null?null:e.touched)),a(),l("disabled",r.requestForm.invalid||r.loading),a(),y(" ",r.loading?"Sending OTP\u2026":"Send OTP"," "),a(4),l("routerLink","/authentication/login"),a(4),l("routerLink","/authentication/register")}}function ge(i,g){i&1&&(o(0,"div",10),s(1," Enter the 6-digit OTP. "),m())}function _e(i,g){i&1&&(o(0,"div",10),s(1," Password must be at least 6 characters. "),m())}function we(i,g){if(i&1){let t=E();o(0,"form",2),C("ngSubmit",function(){k(t);let r=h();return R(r.onResetPassword())}),o(1,"div",11),s(2),m(),o(3,"div",3)(4,"label",12),s(5,"OTP Code"),m(),S(6,"input",13),f(7,ge,2,0,"div",6),m(),o(8,"div",3)(9,"label",14),s(10,"New Password"),m(),S(11,"input",15),f(12,_e,2,0,"div",6),m(),o(13,"button",16),s(14),m(),o(15,"div",8)(16,"p"),s(17," Remembered your password? "),o(18,"a",9),s(19,"Sign In"),m()(),o(20,"p"),s(21," Don't have an account? "),o(22,"a",9),s(23,"Register"),m()()()()}if(i&2){let t,e,r,d,n=h();l("formGroup",n.resetForm),a(2),y(" OTP expires in: ",n.formatTime(n.timeLeft)," "),a(4),l("ngClass",b(10,O,((t=n.resetForm.get("otp_code"))==null?null:t.invalid)&&((t=n.resetForm.get("otp_code"))==null?null:t.touched))),a(),l("ngIf",((e=n.resetForm.get("otp_code"))==null?null:e.invalid)&&((e=n.resetForm.get("otp_code"))==null?null:e.touched)),a(4),l("ngClass",b(12,O,((r=n.resetForm.get("new_pass_key"))==null?null:r.invalid)&&((r=n.resetForm.get("new_pass_key"))==null?null:r.touched))),a(),l("ngIf",((d=n.resetForm.get("new_pass_key"))==null?null:d.invalid)&&((d=n.resetForm.get("new_pass_key"))==null?null:d.touched)),a(),l("disabled",n.resetForm.invalid||n.loading),a(),y(" ",n.loading?"Resetting\u2026":"Reset Password"," "),a(4),l("routerLink","/authentication/login"),a(4),l("routerLink","/authentication/register")}}var le=(()=>{class i{constructor(t,e,r,d,n,pe,ce){this.fb=t,this.resetSvc=e,this.toast=r,this.authCookie=d,this.cookieService=n,this.authService=pe,this.router=ce,this.step=1,this.loading=!1,this.timeLeft=0,this.destroy$=new q}ngOnInit(){this.requestForm=this.fb.group({email:["",[c.required,c.email]]}),this.resetForm=this.fb.group({otp_code:["",[c.required,c.minLength(6),c.maxLength(6)]],new_pass_key:["",[c.required,c.minLength(6)]]})}onRequestOtp(){if(this.requestForm.invalid)return;this.loading=!0;let t=this.requestForm.value.email;this.resetSvc.requestPasswordReset(t).pipe(_(this.destroy$)).subscribe({next:e=>{this.loading=!1,this.authCookie.setOtpToken(e.reset_otp_token,e.otp_expires_at),this.startTimer(new Date(e.otp_expires_at).getTime()),this.step=2,this.toast.show("OTP sent. Check your email.",{class:"bg-success"})},error:e=>{this.loading=!1,this.toast.show(e.message||"Failed to send OTP.",{class:"bg-danger"})}})}onResetPassword(){if(this.resetForm.invalid)return;this.loading=!0;let t=this.authCookie.getOtpToken(),{otp_code:e,new_pass_key:r}=this.resetForm.value;this.resetSvc.resetPasswordByOtp({token:t,otp_code:e,new_pass_key:r}).pipe(_(this.destroy$)).subscribe({next:({token:d,user:n})=>{this.loading=!1,this.clearTimer(),this.authCookie.removeOtpToken(),this.cookieService.delete("otp_expires_at","/"),this.authService.saveSession(d,n),this.toast.show("Password reset successful! You are now logged in.",{class:"bg-success"}),this.router.navigate(["/home"])},error:d=>{this.loading=!1,this.toast.show(d.message||"Reset failed.",{class:"bg-danger"})}})}startTimer(t){this.clearTimer(),this.timeLeft=Math.floor((t-Date.now())/1e3),this.timerSub=M(1e3).pipe(_(this.destroy$)).subscribe(()=>{this.timeLeft--,this.timeLeft<=0&&(this.toast.show("OTP expired. Please request again.",{class:"bg-danger"}),this.clearTimer(),this.step=1)})}clearTimer(){this.timerSub&&(this.timerSub.unsubscribe(),this.timerSub=null)}formatTime(t){let e=Math.floor(t/60),r=t%60;return`${e}:${r<10?"0"+r:r}`}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.clearTimer()}static{this.\u0275fac=function(e){return new(e||i)(p(ee),p(me),p(re),p(Y),p(G),p(Q),p(V))}}static{this.\u0275cmp=$({type:i,selectors:[["app-reset-password"]],decls:5,vars:2,consts:[[1,"text-center","mb-4"],[3,"formGroup","ngSubmit",4,"ngIf"],[3,"ngSubmit","formGroup"],[1,"form-group","mb-3"],["for","email",1,"form-label"],["type","email","id","email","formControlName","email","placeholder","Enter your registered email",1,"form-control",3,"ngClass"],["class","invalid-feedback",4,"ngIf"],["type","submit",1,"btn","btn-primary","w-100","mb-3",3,"disabled"],[1,"text-center"],[1,"text-decoration-none",3,"routerLink"],[1,"invalid-feedback"],[1,"mb-2","text-muted","text-center"],["for","otp_code",1,"form-label"],["type","text","id","otp_code","formControlName","otp_code","maxlength","6","placeholder","Enter the 6-digit code",1,"form-control",3,"ngClass"],["for","new_pass_key",1,"form-label"],["type","password","id","new_pass_key","formControlName","new_pass_key","placeholder","Choose a new password",1,"form-control",3,"ngClass"],["type","submit",1,"btn","btn-success","w-100","mb-3",3,"disabled"]],template:function(e,r){e&1&&(o(0,"div",0)(1,"h4"),s(2,"Reset Your Password"),m()(),f(3,he,17,9,"form",1)(4,we,24,14,"form",1)),e&2&&(a(3),l("ngIf",r.step===1),a(),l("ngIf",r.step===2))},dependencies:[j,D,B,J,U,z,H,Z,K,X,oe]})}}return i})();var ve=[{path:"",component:le,data:{title:"Reset Password",description:"Reset your password using email",keywords:"Forgot password, reset password",robots:"noindex, nofollow"}}],de=(()=>{class i{static{this.\u0275fac=function(e){return new(e||i)}}static{this.\u0275mod=v({type:i})}static{this.\u0275inj=w({imports:[T.forChild(ve),T]})}}return i})();var Ue=(()=>{class i{static{this.\u0275fac=function(e){return new(e||i)}}static{this.\u0275mod=v({type:i})}static{this.\u0275inj=w({imports:[A,de,te,ie,se]})}}return i})();export{Ue as ResetPasswordModule};
