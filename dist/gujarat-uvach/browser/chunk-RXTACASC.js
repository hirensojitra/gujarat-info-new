import{a as le}from"./chunk-NBCQ4A3G.js";import{g as se,n as ae}from"./chunk-N7RYM3VK.js";import{a as ne}from"./chunk-JP4WEFTC.js";import{m as z,o as O}from"./chunk-SQRP6PMK.js";import"./chunk-T4EISGAZ.js";import{a as Y}from"./chunk-YRG5W6VS.js";import{a as W}from"./chunk-7YVPWAOW.js";import{a as U}from"./chunk-RWKAEW2Z.js";import"./chunk-WIB4C2YZ.js";import{A as re,B as ie,C as oe,c as H,e as f,g as J,h as K,m as X,q as Z,t as ee,y as te}from"./chunk-ZDPQXU7Z.js";import{u as G,v as Q,w as I}from"./chunk-KB4EY57F.js";import{$b as _,B as P,Db as g,Ea as E,Fa as C,Fb as m,Hb as w,K as L,O as R,Qb as o,Rb as a,Sb as S,Wb as F,Zb as T,ea as v,g as N,ka as $,kb as n,kc as s,kd as D,la as x,lb as p,mc as k,md as V,pa as j,va as A,w as u,wa as y,wc as b,wd as B}from"./chunk-YECJCXI6.js";import"./chunk-CWTPBX7D.js";var me=O`
  mutation RequestPasswordReset($email: String!) {
    requestPasswordReset(email: $email) {
      reset_otp_token
      otp_expires_at
    }
  }
`,de=O`
  mutation ResetPasswordByOtp(
    $token: String!
    $otp_code: String!
    $new_pass_key: String!
  ) {
    resetPasswordByOtp(
      token: $token
      otp_code: $otp_code
      new_pass_key: $new_pass_key
    ) {
      token
      user {
        id
        firstname
        middlename
        lastname
        number
        number_verified
        role_id
        email
        email_verified
        username
        birthday
        gender
        marital_status
        language {
          id
          name
        }
      }
    }
  }
`;var pe=(()=>{class i{constructor(t){this.apollo=t}requestPasswordReset(t){return this.apollo.mutate({mutation:me,variables:{email:t},fetchPolicy:"network-only",errorPolicy:"none"}).pipe(P(e=>{if(!e.data)throw new Error("No data received");return e.data.requestPasswordReset}),R(e=>{if(e.networkError)return u(()=>new Error("Network error: Could not connect to the server. Please check your internet connection or try again later."));let r=e.graphQLErrors?.[0]?.message;return r?u(()=>new Error(r)):u(()=>new Error(e.message))}))}resetPasswordByOtp(t){return this.apollo.mutate({mutation:de,variables:{token:t.token,otp_code:t.otp_code,new_pass_key:t.new_pass_key},fetchPolicy:"network-only",errorPolicy:"none"}).pipe(P(e=>{if(!e.data)throw new Error("No data received");return e.data.resetPasswordByOtp}),R(e=>{if(e.networkError)return u(()=>new Error("Network error: Could not connect to the server. Please check your internet connection or try again later."));let r=e.graphQLErrors?.[0]?.message;return r?u(()=>new Error(r)):u(()=>new Error(e.message))}))}static{this.\u0275fac=function(e){return new(e||i)(j(z))}}static{this.\u0275prov=$({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var M=i=>({"is-invalid":i});function he(i,h){i&1&&(o(0,"div",10),s(1," Please enter a valid email. "),a())}function ge(i,h){if(i&1){let t=F();o(0,"form",2),T("ngSubmit",function(){E(t);let r=_();return C(r.onRequestOtp())}),o(1,"div",3)(2,"label",4),s(3,"Email Address"),a(),S(4,"input",5),g(5,he,2,0,"div",6),a(),o(6,"button",7),s(7),a(),o(8,"div",8)(9,"p"),s(10," Remembered your password? "),o(11,"a",9),s(12,"Sign In"),a()(),o(13,"p"),s(14," Don't have an account? "),o(15,"a",9),s(16,"Register"),a()()()()}if(i&2){let t,e,r=_();m("formGroup",r.requestForm),n(4),m("ngClass",b(7,M,((t=r.requestForm.get("email"))==null?null:t.invalid)&&((t=r.requestForm.get("email"))==null?null:t.touched))),n(),m("ngIf",((e=r.requestForm.get("email"))==null?null:e.invalid)&&((e=r.requestForm.get("email"))==null?null:e.touched)),n(),m("disabled",r.requestForm.invalid||r.loading),n(),k(" ",r.loading?"Sending OTP\u2026":"Send OTP"," "),n(4),m("routerLink","/authentication/login"),n(4),m("routerLink","/authentication/register")}}function we(i,h){i&1&&(o(0,"div",10),s(1," Enter the 6-digit OTP. "),a())}function ve(i,h){i&1&&(o(0,"div"),s(1,"New password is required."),a())}function xe(i,h){if(i&1&&(o(0,"div"),s(1," Password must meet the following criteria: "),o(2,"ul")(3,"li"),s(4,"At least 8 characters"),a(),o(5,"li"),s(6,"At least one uppercase letter"),a(),o(7,"li"),s(8,"At least one lowercase letter"),a(),o(9,"li"),s(10,"At least one digit"),a(),o(11,"li"),s(12,"At least one special character"),a()()()),i&2){let t,e,r,d,l,c=_(3);n(3),w("text-success",(t=c.resetForm.get("new_pass_key"))==null||t.errors==null?null:t.errors.hasMinLength),n(2),w("text-success",(e=c.resetForm.get("new_pass_key"))==null||e.errors==null?null:e.errors.hasUpperCase),n(2),w("text-success",(r=c.resetForm.get("new_pass_key"))==null||r.errors==null?null:r.errors.hasLowerCase),n(2),w("text-success",(d=c.resetForm.get("new_pass_key"))==null||d.errors==null?null:d.errors.hasDigit),n(2),w("text-success",(l=c.resetForm.get("new_pass_key"))==null||l.errors==null?null:l.errors.hasSpecialChar)}}function ye(i,h){if(i&1&&(o(0,"div",10),g(1,ve,2,0,"div",17)(2,xe,13,10,"div",17),a()),i&2){let t,e,r=_(2);n(),m("ngIf",(t=r.resetForm.get("new_pass_key"))==null||t.errors==null?null:t.errors.required),n(),m("ngIf",(e=r.resetForm.get("new_pass_key"))==null||e.errors==null?null:e.errors.passwordStrength)}}function Se(i,h){if(i&1){let t=F();o(0,"form",2),T("ngSubmit",function(){E(t);let r=_();return C(r.onResetPassword())}),o(1,"div",11),s(2),a(),o(3,"div",3)(4,"label",12),s(5,"OTP Code"),a(),S(6,"input",13),g(7,we,2,0,"div",6),a(),o(8,"div",3)(9,"label",14),s(10,"New Password"),a(),S(11,"input",15),g(12,ye,3,2,"div",6),a(),o(13,"button",16),s(14),a(),o(15,"div",8)(16,"p"),s(17," Remembered your password? "),o(18,"a",9),s(19,"Sign In"),a()(),o(20,"p"),s(21," Don't have an account? "),o(22,"a",9),s(23,"Register"),a()()()()}if(i&2){let t,e,r,d,l=_();m("formGroup",l.resetForm),n(2),k(" OTP expires in: ",l.formatTime(l.timeLeft)," "),n(4),m("ngClass",b(10,M,((t=l.resetForm.get("otp_code"))==null?null:t.invalid)&&((t=l.resetForm.get("otp_code"))==null?null:t.touched))),n(),m("ngIf",((e=l.resetForm.get("otp_code"))==null?null:e.invalid)&&((e=l.resetForm.get("otp_code"))==null?null:e.touched)),n(4),m("ngClass",b(12,M,((r=l.resetForm.get("new_pass_key"))==null?null:r.invalid)&&((r=l.resetForm.get("new_pass_key"))==null?null:r.touched))),n(),m("ngIf",((d=l.resetForm.get("new_pass_key"))==null?null:d.invalid)&&((d=l.resetForm.get("new_pass_key"))==null?null:d.touched)),n(),m("disabled",l.resetForm.invalid||l.loading),n(),k(" ",l.loading?"Resetting\u2026":"Reset Password"," "),n(4),m("routerLink","/authentication/login"),n(4),m("routerLink","/authentication/register")}}var ce=(()=>{class i{constructor(t,e,r,d,l,c,_e){this.fb=t,this.resetSvc=e,this.toast=r,this.authCookie=d,this.cookieService=l,this.authService=c,this.router=_e,this.step=1,this.loading=!1,this.timeLeft=0,this.destroy$=new N}ngOnInit(){this.requestForm=this.fb.group({email:["",[f.required,f.email]]}),this.resetForm=this.fb.group({otp_code:["",[f.required,f.minLength(6),f.maxLength(6)]],new_pass_key:["",[f.required,le]]})}onRequestOtp(){if(this.requestForm.invalid)return;this.loading=!0;let t=this.requestForm.value.email;this.resetSvc.requestPasswordReset(t).pipe(v(this.destroy$)).subscribe({next:e=>{this.loading=!1,this.authCookie.setOtpToken(e.reset_otp_token,e.otp_expires_at),this.startTimer(new Date(e.otp_expires_at).getTime()),this.step=2,this.toast.show("OTP sent. Check your email.",{class:"bg-success"})},error:e=>{this.loading=!1,this.toast.show(e.message||"Failed to send OTP.",{class:"bg-danger"})}})}onResetPassword(){if(this.resetForm.invalid)return;this.loading=!0;let t=this.authCookie.getOtpToken(),{otp_code:e,new_pass_key:r}=this.resetForm.value;this.resetSvc.resetPasswordByOtp({token:t,otp_code:e,new_pass_key:r}).pipe(v(this.destroy$)).subscribe({next:({token:d,user:l})=>{this.loading=!1,this.clearTimer(),this.authCookie.removeOtpToken(),this.cookieService.delete("otp_expires_at","/"),this.authService.saveSession(d,l),this.toast.show("Password reset successful! You are now logged in.",{class:"bg-success"}),this.router.navigate(["/home"])},error:d=>{this.loading=!1,this.toast.show(d.message||"Reset failed.",{class:"bg-danger"})}})}startTimer(t){this.clearTimer(),this.timeLeft=Math.floor((t-Date.now())/1e3),this.timerSub=L(1e3).pipe(v(this.destroy$)).subscribe(()=>{this.timeLeft--,this.timeLeft<=0&&(this.toast.show("OTP expired. Please request again.",{class:"bg-danger"}),this.clearTimer(),this.step=1)})}clearTimer(){this.timerSub&&(this.timerSub.unsubscribe(),this.timerSub=null)}formatTime(t){let e=Math.floor(t/60),r=t%60;return`${e}:${r<10?"0"+r:r}`}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.clearTimer()}static{this.\u0275fac=function(e){return new(e||i)(p(re),p(pe),p(ne),p(W),p(U),p(Y),p(G))}}static{this.\u0275cmp=A({type:i,selectors:[["app-reset-password"]],decls:5,vars:2,consts:[[1,"text-center","mb-4"],[3,"formGroup","ngSubmit",4,"ngIf"],[3,"ngSubmit","formGroup"],[1,"form-group","mb-3"],["for","email",1,"form-label"],["type","email","id","email","formControlName","email","placeholder","Enter your registered email",1,"form-control",3,"ngClass"],["class","invalid-feedback",4,"ngIf"],["type","submit",1,"btn","btn-primary","w-100","mb-3",3,"disabled"],[1,"text-center"],[1,"text-decoration-none",3,"routerLink"],[1,"invalid-feedback"],[1,"mb-2","text-muted","text-center"],["for","otp_code",1,"form-label"],["type","text","id","otp_code","formControlName","otp_code","maxlength","6","placeholder","Enter the 6-digit code",1,"form-control",3,"ngClass"],["for","new_pass_key",1,"form-label"],["type","password","id","new_pass_key","formControlName","new_pass_key","placeholder","Choose a new password",1,"form-control",3,"ngClass"],["type","submit",1,"btn","btn-success","w-100","mb-3",3,"disabled"],[4,"ngIf"]],template:function(e,r){e&1&&(o(0,"div",0)(1,"h4"),s(2,"Reset Your Password"),a()(),g(3,ge,17,9,"form",1)(4,Se,24,14,"form",1)),e&2&&(n(3),m("ngIf",r.step===1),n(),m("ngIf",r.step===2))},dependencies:[D,V,Q,X,H,J,K,te,Z,ee,se]})}}return i})();var ke=[{path:"",component:ce,data:{title:"Reset Password",description:"Reset your password using email",keywords:"Forgot password, reset password",robots:"noindex, nofollow"}}],ue=(()=>{class i{static{this.\u0275fac=function(e){return new(e||i)}}static{this.\u0275mod=y({type:i})}static{this.\u0275inj=x({imports:[I.forChild(ke),I]})}}return i})();var Xe=(()=>{class i{static{this.\u0275fac=function(e){return new(e||i)}}static{this.\u0275mod=y({type:i})}static{this.\u0275inj=x({imports:[B,ue,ie,oe,ae]})}}return i})();export{Xe as ResetPasswordModule};
