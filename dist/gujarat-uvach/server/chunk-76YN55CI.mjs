import './polyfills.server.mjs';
import{a as J}from"./chunk-YS7AQAUF.mjs";import{a as Q}from"./chunk-GEAKS7UG.mjs";import{a as L}from"./chunk-WNVNUZNF.mjs";import"./chunk-JVYDACQO.mjs";import{l as P}from"./chunk-WQAH27MK.mjs";import{a as H}from"./chunk-PQHBR4RA.mjs";import"./chunk-ZOSFQCFM.mjs";import{a as j}from"./chunk-SBPX72W3.mjs";import{c as N,d as f,f as R,g as A,k as D,o as G,r as $,v as q,x as B,y as K,z}from"./chunk-DXF4L3C7.mjs";import{a as F}from"./chunk-D7IAKCP3.mjs";import{A as y,v as M,y as V}from"./chunk-W6Z6YZO4.mjs";import{Bb as d,I as g,Lb as l,M as w,Mb as a,Nb as k,Sb as b,Ub as T,a as S,cc as c,dd as E,ec as p,fd as I,ha as u,hb as s,ib as n,mc as x,od as O,ra as C,sa as h,u as _,zb as v}from"./chunk-MA44MDZG.mjs";import"./chunk-VVCT4QZE.mjs";var re=i=>({"is-invalid":i});function se(i,Y){i&1&&(l(0,"div",11),c(1," Please enter a valid 6-digit code. "),a())}function ne(i,Y){if(i&1&&(l(0,"div",12),c(1),a()),i&2){let o=T();s(),p(" ",o.errorMessage," ")}}var W=(()=>{class i{constructor(o,t,e,r,m,Z,ee,te,ie,oe){this.route=o,this.fb=t,this.apollo=e,this.router=r,this.toast=m,this.registerService=Z,this.loginService=ee,this.authCookie=te,this.cookieService=ie,this.authService=oe,this.loading=!1,this.errorMessage="",this.userId="",this.emailOtpToken="",this.timeLeft=0,this.resendCooldown=0,this.user=null,this.subscriptions=new S}ngOnInit(){this.subscriptions.add(this.authService.user$.subscribe(r=>{this.user=r,console.log("user",this.user)})),this.verifyForm=this.fb.group({otp_code:["",[f.required,f.minLength(6),f.maxLength(6)]]}),this.emailOtpToken=this.authCookie.getOtpToken();let o=this.cookieService.get("otp_expires_at");if(!this.emailOtpToken||!o){this.toast.show("Verification session expired.",{class:"bg-danger"});return}let t=new Date(o).getTime(),e=Date.now();this.timeLeft=Math.floor((t-e)/1e3),this.timeLeft<=0?this.expireSession():this.startTimer(),this.resendCooldown=0}startTimer(){this.timerSub=g(1e3).subscribe(()=>{this.timeLeft--,this.timeLeft<=0&&this.expireSession()})}expireSession(){this.stopTimer(),this.toast.show("OTP expired. Please request a new one.",{class:"bg-danger"}),this.authCookie.removeOtpToken(),this.cookieService.delete("otp_expires_at","/"),this.router.navigate(["/authentication/login"])}stopTimer(){this.timerSub?.unsubscribe()}verifyOtp(){if(this.verifyForm.invalid)return;this.loading=!0;let o=this.verifyForm.value.otp_code,t=this.emailOtpToken;this.registerService.verifyOtp(t,o).pipe(w(e=>(this.loading=!1,this.toast.show(e.message||"Verification failed.",{class:"bg-danger"}),_(()=>e)))).subscribe(({token:e,user:r})=>{this.loading=!1,this.authService.saveSession(e,r),this.toast.show("Email verified successfully!",{class:"bg-success"}),this.clearSession(),this.router.navigate(["/home"])})}onResend(){if(this.resendCooldown>0)return;let o=this.user.email;if(!o){this.toast.show("Session expired. Please login again.",{class:"bg-danger"}),this.router.navigate(["/authentication/login"]);return}this.registerService.resendOtp(o).subscribe({next:({data:t})=>{let{email_otp_token:e,otp_expires_at:r}=t.resendEmailOtp;this.authCookie.setOtpToken(e,r),this.emailOtpToken=e,this.stopTimer();let m=new Date(r).getTime();this.timeLeft=Math.floor((m-Date.now())/1e3),this.startTimer(),this.resendCooldown=30,this.cooldownSub=g(1e3).subscribe(()=>{this.resendCooldown--,this.resendCooldown<=0&&this.cooldownSub?.unsubscribe()}),this.toast.show("OTP resent. Check your inbox.",{class:"bg-success"})},error:t=>{this.toast.show(t.message||"Could not resend OTP.",{class:"bg-danger"})}})}formatTime(o){let t=Math.floor(o/60),e=o%60;return`${t}:${e<10?"0"+e:e}`}autoLoginAfterVerification(){let o=this.registerService.getEmail(),t=this.registerService.getPassKey();if(!o||!t){this.toast.show("Session expired. Please login again.",{class:"bg-danger"}),this.router.navigate(["/authentication/login"]);return}this.loginService.login({login_id:o,pass_key:t}).subscribe({next:e=>{this.authCookie.setToken(e.token),this.toast.show("Logged in successfully!",{class:"bg-success"}),this.router.navigate(["/home"])},error:()=>{this.toast.show("Login failed. Please try again.",{class:"bg-danger"}),this.router.navigate(["/authentication/login"])}})}clearSession(){this.stopTimer(),this.cooldownSub?.unsubscribe(),this.authCookie.removeOtpToken(),this.cookieService.delete("otp_expires_at","/")}ngOnDestroy(){this.clearSession()}static{this.\u0275fac=function(t){return new(t||i)(n(M),n(B),n(P),n(V),n(H),n(J),n(Q),n(L),n(F),n(j))}}static{this.\u0275cmp=C({type:i,selectors:[["app-verify-email"]],decls:17,vars:11,consts:[[1,"d-flex","flex-column","align-items-center","justify-content-center"],[1,"w-100","px-3",2,"max-width","400px",3,"ngSubmit","formGroup"],[1,"mb-3"],["for","otp_code",1,"form-label"],["id","otp_code","type","text","formControlName","otp_code","maxlength","6",1,"form-control",3,"ngClass"],["class","invalid-feedback",4,"ngIf"],[1,"mb-2","text-muted"],[1,"mb-3","text-center"],["type","button",1,"btn","btn-link","p-0",3,"click","disabled"],["type","submit",1,"btn","btn-primary","w-100",3,"disabled"],["class","alert alert-danger mt-3",4,"ngIf"],[1,"invalid-feedback"],[1,"alert","alert-danger","mt-3"]],template:function(t,e){if(t&1&&(l(0,"div",0)(1,"h2"),c(2,"Email Verification"),a(),l(3,"form",1),b("ngSubmit",function(){return e.verifyOtp()}),l(4,"div",2)(5,"label",3),c(6,"Enter OTP"),a(),k(7,"input",4),v(8,se,2,0,"div",5),a(),l(9,"div",6),c(10),a(),l(11,"div",7)(12,"button",8),b("click",function(){return e.onResend()}),c(13),a()(),l(14,"button",9),c(15),a(),v(16,ne,2,1,"div",10),a()()),t&2){let r,m;s(3),d("formGroup",e.verifyForm),s(4),d("ngClass",x(9,re,((r=e.verifyForm.get("otp_code"))==null?null:r.invalid)&&((r=e.verifyForm.get("otp_code"))==null?null:r.touched))),s(),d("ngIf",((m=e.verifyForm.get("otp_code"))==null?null:m.invalid)&&((m=e.verifyForm.get("otp_code"))==null?null:m.touched)),s(2),p(" Time left: ",e.formatTime(e.timeLeft)," "),s(2),d("disabled",e.resendCooldown>0),s(),p(" ",e.resendCooldown>0?"Resend OTP ("+e.resendCooldown+"s)":"Resend OTP"," "),s(),d("disabled",e.verifyForm.invalid||e.loading),s(),p(" ",e.loading?"Verifying\u2026":"Verify OTP"," "),s(),d("ngIf",e.errorMessage)}},dependencies:[E,I,D,N,R,A,q,G,$]})}}return i})();var ae=[{path:"",component:W,data:{title:"PostNew | Register",description:"Login or register to PostNew portal for accessing services",keywords:"PostNew, login, register, portal",robots:"index, follow",image:"https://test-ssr-hiren.netlify.app/assets/images/jpg/register.jpg"}}],X=(()=>{class i{static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275mod=h({type:i})}static{this.\u0275inj=u({imports:[y.forChild(ae),y]})}}return i})();var Oe=(()=>{class i{static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275mod=h({type:i})}static{this.\u0275inj=u({imports:[O,X,K,z]})}}return i})();export{Oe as VerifyEmailModule};
